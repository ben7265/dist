<xten name="image" element="div">
    <mandatory>name</mandatory>
    <allow>owner, admin</allow>
    <view>
        <img src="[$src||images/blank.jpg]" alt="[$alt||$name]" />
        <toolbar top="[$toolbar-top||0]" left="[$toolbar-left||0]" right="[$toolbar-right||auto]" bottom="[$toolbar-bottom||auto]">
            <icon name="save">
                <tooltip>upload image</tooltip>
                <click fname="_imageSaveImage">
                    <upload name="save-image" file="changed-file" file-url="uploaded-url" />
                    <set-attrib name="src" child="img">
                        toolbarParent['uploaded-url']
                    </set-attrib>
                    <set-attrib name="src">
                        toolbarParent['uploaded-url']
                    </set-attrib>
                    <unset-var name="uploaded-url" />
                    <unset-var name="changed-file" />
                    <remove-class classes="image-changed" />
                </click>
            </icon>
            <icon name="close">
                <tooltip>cancel</tooltip>
                <click fname="_imageCancelImageSave">
                    <set-attrib name="src" child="img">
                        toolbarParent.getAttribute('src')
                    </set-attrib>
                    <unset-var name="changed-file" />
                    <remove-class classes="image-changed" />
                </click>
            </icon>
            <icon name="upload">
                <tooltip>select image</tooltip>
                <event name="click" fname="_imageUploadImage">
                    <selectfile file-type="image/*" file="changed-file" />
                    <set-attrib name="src" child="img">
                        URL.createObjectURL(toolbarParent['changed-file'])
                    </set-attrib>
                    <add-class classes="image-changed" />
                </event>
            </icon>
        </toolbar>
    </view>

    <style>
        display: flex;
        position: relative;
        overflow: hidden;
        width: 100%;
        max-height: 100%;
        justify-content: center;
        align-items: center;
    </style>

    <nodeStyle>
        aspect-ratio: [$aspect-ratio||auto];
    </nodeStyle>

    <css>
        .wx-xten-image > .wx-xten-toolbar {
            display: none;
            position: relative;
        }
        .wx-xten-image.wx-state-editable .wx-xten-toolbar {display: inline-block;}
        .wx-xten-image.image-changed .wx-xten-toolbar {display: inline-block;}
        .wx-xten-image.image-changed {border: 5px solid red;}
        .wx-xten-image > img {
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            object-position: center;
        }
        .wx-xten-image > .wx-xten-toolbar > .close {display: none;}
        .wx-xten-image > .wx-xten-toolbar > .save {display: none;}
        .wx-xten-image.image-changed > .wx-xten-toolbar > .close {display: inline-block;}
        .wx-xten-image.image-changed > .wx-xten-toolbar > .save {display: inline-block;}
    </css>

    <cssNode>
        #[$id] > img {
            aspect-ratio: [$aspect-ratio||auto];
        }

        #[$id].wx-state-editable > .wx-xten-toolbar {
            display: inline-block;
            position: absolute;
            top: [$toolbar-top||0];
            left: [$toolbar-left||0];
            right: [$toolbar-right||auto];
            bottom: [$toolbar-bottom||auto];
        }
    </cssNode>

    <initElement>
    <%
        const ratio = parseFloat(element.getAttribute('aspect-ratio') || 0);
        if (ratio) {
            element.style.height = (element.offsetWidth * ratio) + 'px';
        }

        element.setAttribute('src', element.querySelector('img').getAttribute('src'));
        /*
        const image = element.querySelector('img');

        var containerWidth = element.offsetWidth;
        var containerHeight = element.offsetHeight;

        var imageWidth = image.naturalWidth;
        var imageHeight = image.naturalHeight;

        if (containerHeight && imageHeight) {
            var containerRatio = containerWidth / containerHeight;
            var imageRatio = imageWidth / imageHeight;
        }

        if (ratio) {
            containerWidth = element.offsetWidth;
            containerHeight = Math.round(containerWidth * ratio);
            element.style.height = containerHeight.toString() + 'px';

            var containerWidth = element.offsetWidth;
            var containerHeight = element.offsetHeight;

            var imageWidth = image.naturalWidth;
            var imageHeight = image.naturalHeight;

            var containerRatio = containerWidth / containerHeight;
            var imageRatio = imageWidth / imageHeight;

            if (containerRatio < imageRatio) {
                image.style.height = 'auto';
                image.style.width = '100%';
                image.style.margin = 'auto';
            }
            else
            {
                image.style.height = '100%';
                image.style.width = 'auto';
                image.style.margin = 'auto';
            }

            const resizeObserver = new ResizeObserver(entries => {
                const containerWidth = element.offsetWidth;
                const containerHeight = Math.round(containerWidth * ratio);
                element.style.height = containerHeight.toString() + 'px';
            });
            resizeObserver.observe(element);
        }
        */
    %>
    </initElement>

    <load>
        const value = await database.inlineValue(node, context, xten);
        if (value) {
            node.attribs.src = value;
            const img = node.findChildren('img')[0];
            img.attribs.src = value;
        }
    </load>
</xten>
